<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Keyboard MIDI Player</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            width: 100%;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 30px;
            margin-bottom: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #495057;
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            color: #6c757d;
            font-size: 1.1em;
        }

        .song-input-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .song-input-section h3 {
            color: #495057;
            margin-bottom: 15px;
            font-weight: 400;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        #songInput {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        #songInput:focus {
            outline: none;
            border-color: #6c757d;
        }

        .btn {
            padding: 12px 24px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }

        .btn:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .song-display {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            border-left: 4px solid #6c757d;
            min-height: 60px;
            display: none;
        }

        .song-display.active {
            display: block;
        }

        .piano-container {
            display: flex;
            justify-content: center;
            margin: 30px 0;
            perspective: 1000px;
        }

        .piano {
            position: relative;
            display: flex;
            background: #343a40;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .key {
            position: relative;
            cursor: pointer;
            user-select: none;
            transition: all 0.1s;
            border-radius: 0 0 8px 8px;
        }

        .white-key {
            width: 70px;
            height: 280px;
            background: linear-gradient(to bottom, #ffffff 0%, #f8f9fa 100%);
            border: 2px solid #dee2e6;
            margin: 0 2px;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            padding-bottom: 15px;
            font-size: 14px;
            color: #6c757d;
            font-weight: bold;
        }

        .white-key:hover {
            background: linear-gradient(to bottom, #f8f9fa 0%, #e9ecef 100%);
            transform: translateY(-2px);
        }

        .white-key.active {
            background: linear-gradient(to bottom, #e9ecef 0%, #dee2e6 100%);
            transform: translateY(4px);
            box-shadow: inset 0 3px 10px rgba(0,0,0,0.2);
        }

        .black-key {
            width: 42px;
            height: 180px;
            background: linear-gradient(to bottom, #343a40 0%, #212529 100%);
            position: absolute;
            top: 20px;
            border-radius: 0 0 7px 7px;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            padding-bottom: 12px;
            font-size: 12px;
            color: #adb5bd;
            font-weight: bold;
            z-index: 2;
        }

        .black-key:hover {
            background: linear-gradient(to bottom, #495057 0%, #343a40 100%);
            transform: translateY(-1px);
        }

        .black-key.active {
            background: linear-gradient(to bottom, #212529 0%, #000000 100%);
            transform: translateY(2px);
            box-shadow: inset 0 2px 8px rgba(0,0,0,0.5);
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .control-group label {
            color: #6c757d;
            font-size: 14px;
            font-weight: 500;
        }

        .slider {
            width: 120px;
            height: 6px;
            border-radius: 3px;
            background: #dee2e6;
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #6c757d;
            cursor: pointer;
            transition: all 0.3s;
        }

        .slider::-webkit-slider-thumb:hover {
            background: #5a6268;
            transform: scale(1.2);
        }

        .instructions {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
        }

        .instructions h4 {
            color: #495057;
            margin-bottom: 10px;
        }

        .instructions p {
            color: #6c757d;
            margin-bottom: 8px;
        }

        .recording-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 25px 0;
            flex-wrap: wrap;
        }

        .record-btn {
            padding: 15px 30px;
            font-size: 16px;
            font-weight: bold;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 140px;
        }

        .record-btn.start {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
        }

        .record-btn.start:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
        }

        .record-btn.start.recording {
            background: linear-gradient(135deg, #dc3545, #fd7e14);
            animation: pulse 1.5s infinite;
        }

        .record-btn.stop {
            background: linear-gradient(135deg, #6c757d, #495057);
            color: white;
        }

        .record-btn.stop:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(108, 117, 125, 0.4);
        }

        .record-btn.save {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
        }

        .record-btn.save:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 123, 255, 0.4);
        }

        .record-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        .recording-status {
            text-align: center;
            margin: 15px 0;
            font-size: 16px;
            font-weight: 500;
            min-height: 25px;
        }

        .recording-status.recording {
            color: #dc3545;
        }

        .recording-status.ready {
            color: #28a745;
        }

        @media (max-width: 768px) {
            .piano {
                transform: scale(0.5);
                transform-origin: center;
            }
            
            .container {
                padding: 20px;
            }
            
            .recording-controls {
                gap: 10px;
            }
            
            .record-btn {
                padding: 12px 20px;
                font-size: 14px;
                min-width: 120px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎹 Keyboard MIDI Player</h1>
            <p>Spielen Sie Klavier mit Ihrer Maus oder Computertastatur</p>
        </div>

        <div class="song-input-section">
            <h3>Song eingeben</h3>
            <div class="input-group">
                <input type="text" id="songInput" placeholder="Geben Sie einen Songtitel oder Melodie ein (z.B. 'Twinkle Twinkle Little Star', 'C D E F G A B')">
                <button class="btn" onclick="analyzeSong()">Analysieren</button>
            </div>
            <div id="songDisplay" class="song-display">
                <h4>Erkannte Notenfolgе:</h4>
                <p id="songNotes"></p>
                <button class="btn" onclick="playSong()" style="margin-top: 10px;">Song abspielen</button>
            </div>
        </div>

        <div class="controls">
            <div class="control-group">
                <label for="volumeSlider">Lautstärke</label>
                <input type="range" id="volumeSlider" class="slider" min="0" max="100" value="70">
            </div>
            <div class="control-group">
                <label for="tempoSlider">Tempo</label>
                <input type="range" id="tempoSlider" class="slider" min="60" max="200" value="120">
            </div>
        </div>

        <div class="recording-controls">
            <button class="record-btn start" id="startBtn" onclick="startRecording()">🔴 START</button>
            <button class="record-btn stop" id="stopBtn" onclick="stopRecording()" disabled>⏹️ STOP</button>
            <button class="record-btn save" id="saveBtn" onclick="saveRecording()" disabled>💾 SPEICHERN</button>
        </div>

        <div class="recording-status" id="recordingStatus">Bereit zum Aufnehmen</div>

        <div class="note-indicator" id="noteIndicator">Drücken Sie eine Taste oder klicken Sie auf das Klavier</div>

        <div class="piano-container">
            <div class="piano" id="piano">
                <!-- Keys will be generated by JavaScript -->
            </div>
        </div>

        <div class="instructions">
            <h4>Bedienung:</h4>
            <p><strong>Computertastatur:</strong> A S D F G H J K L (weiße Tasten), W E T Y U O P (schwarze Tasten)</p>
            <p><strong>Maus:</strong> Klicken Sie auf die Klaviertasten</p>
            <p><strong>Songs:</strong> Geben Sie Songtitel oder Notenfolgen ein (C D E F G A B)</p>
            <p><strong>Aufnahme:</strong> START → Melodie spielen → STOP → SPEICHERN als WAV-Datei</p>
            
            <h4 style="margin-top: 20px;">Verfügbare Songs:</h4>
            <p><strong>Deutsche Lieder:</strong> "Oh Tannenbaum", "Alle meine Entchen", "Hänschen klein", "Backe backe Kuchen", "Bruder Jakob"</p>
            <p><strong>Internationale Lieder:</strong> "Twinkle Twinkle Little Star", "Happy Birthday", "Mary had a little lamb", "London Bridge", "Frère Jacques", "Old MacDonald", "Ode to Joy"</p>
            <p><strong>Direkte Eingabe:</strong> Notennamen wie "C D E F G A B" oder "C4 D4 E4 F4 G4"</p>
        </div>
    </div>

    <script>
        // Audio Context Setup
        let audioContext;
        let currentNotes = [];
        let isPlaying = false;
        let songSequence = [];
        let isRecording = false;
        let recordedNotes = [];
        let recordingStartTime = 0;
        let mediaRecorder;
        let recordedChunks = [];

        // Initialize Audio Context
        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
        }

        // Note frequencies (A4 = 440 Hz)
        const noteFrequencies = {
            'C4': 261.63, 'C#4': 277.18, 'D4': 293.66, 'D#4': 311.13,
            'E4': 329.63, 'F4': 349.23, 'F#4': 369.99, 'G4': 392.00,
            'G#4': 415.30, 'A4': 440.00, 'A#4': 466.16, 'B4': 493.88,
            'C5': 523.25, 'C#5': 554.37, 'D5': 587.33, 'D#5': 622.25,
            'E5': 659.25, 'F5': 698.46, 'F#5': 739.99, 'G5': 783.99
        };

        // Key mappings
        const keyMappings = {
            'a': 'C4', 's': 'D4', 'd': 'E4', 'f': 'F4', 'g': 'G4', 'h': 'A4', 'j': 'B4', 'k': 'C5', 'l': 'D5',
            'w': 'C#4', 'e': 'D#4', 't': 'F#4', 'y': 'G#4', 'u': 'A#4', 'o': 'C#5', 'p': 'D#5'
        };

        // Generate piano keys
        function generatePiano() {
            const piano = document.getElementById('piano');
            const whiteKeys = ['C4', 'D4', 'E4', 'F4', 'G4', 'A4', 'B4', 'C5', 'D5'];
            const blackKeys = [
                { note: 'C#4', position: 35 },
                { note: 'D#4', position: 87 },
                { note: 'F#4', position: 189 },
                { note: 'G#4', position: 241 },
                { note: 'A#4', position: 293 },
                { note: 'C#5', position: 395 },
                { note: 'D#5', position: 447 }
            ];

            // Create white keys
            whiteKeys.forEach(note => {
                const key = document.createElement('div');
                key.className = 'key white-key';
                key.dataset.note = note;
                key.textContent = note;
                key.addEventListener('mousedown', () => playNote(note));
                key.addEventListener('mouseup', () => stopNote(note));
                key.addEventListener('mouseleave', () => stopNote(note));
                piano.appendChild(key);
            });

            // Create black keys
            blackKeys.forEach(({ note, position }) => {
                const key = document.createElement('div');
                key.className = 'key black-key';
                key.dataset.note = note;
                key.textContent = note;
                key.style.left = (position * 1.4) + 'px'; // Adjusted for larger keys
                key.addEventListener('mousedown', () => playNote(note));
                key.addEventListener('mouseup', () => stopNote(note));
                key.addEventListener('mouseleave', () => stopNote(note));
                piano.appendChild(key);
            });
        }

        // Play a note
        function playNote(note) {
            initAudio();
            
            if (currentNotes[note]) return; // Note already playing

            const frequency = noteFrequencies[note];
            if (!frequency) return;

            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            // Also connect to recording destination if recording
            if (isRecording && window.recordingDestination) {
                gainNode.connect(window.recordingDestination);
            }
            
            oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
            oscillator.type = 'sine';
            
            const volume = document.getElementById('volumeSlider').value / 100;
            gainNode.gain.setValueAtTime(0, audioContext.currentTime);
            gainNode.gain.linearRampToValueAtTime(volume * 0.3, audioContext.currentTime + 0.01);
            
            oscillator.start(audioContext.currentTime);
            
            currentNotes[note] = { oscillator, gainNode };
            
            // Record note if recording
            if (isRecording) {
                const currentTime = Date.now() - recordingStartTime;
                recordedNotes.push({ note, time: currentTime, type: 'start' });
            }
            
            // Visual feedback
            const keyElement = document.querySelector(`[data-note="${note}"]`);
            if (keyElement) {
                keyElement.classList.add('active');
            }
            
            // Update note indicator
            document.getElementById('noteIndicator').textContent = `Spielend: ${note}`;
        }

        // Stop a note
        function stopNote(note) {
            if (!currentNotes[note]) return;

            const { oscillator, gainNode } = currentNotes[note];
            
            gainNode.gain.linearRampToValueAtTime(0, audioContext.currentTime + 0.1);
            oscillator.stop(audioContext.currentTime + 0.1);
            
            delete currentNotes[note];
            
            // Record note stop if recording
            if (isRecording) {
                const currentTime = Date.now() - recordingStartTime;
                recordedNotes.push({ note, time: currentTime, type: 'stop' });
            }
            
            // Remove visual feedback
            const keyElement = document.querySelector(`[data-note="${note}"]`);
            if (keyElement) {
                keyElement.classList.remove('active');
            }
            
            // Update note indicator
            if (Object.keys(currentNotes).length === 0) {
                document.getElementById('noteIndicator').textContent = 'Drücken Sie eine Taste oder klicken Sie auf das Klavier';
            }
        }

        // Keyboard event handlers
        document.addEventListener('keydown', (event) => {
            const key = event.key.toLowerCase();
            const note = keyMappings[key];
            if (note && !event.repeat) {
                playNote(note);
            }
        });

        document.addEventListener('keyup', (event) => {
            const key = event.key.toLowerCase();
            const note = keyMappings[key];
            if (note) {
                stopNote(note);
            }
        });

        // Song analysis function
        function analyzeSong() {
            const input = document.getElementById('songInput').value.trim().toLowerCase();
            const songDisplay = document.getElementById('songDisplay');
            const songNotes = document.getElementById('songNotes');
            
            if (!input) return;

            // Simple pattern matching for common songs and note sequences
            let sequence = [];
            
            // Check for specific songs
            if (input.includes('twinkle') || input.includes('funkeln')) {
                sequence = ['C4', 'C4', 'G4', 'G4', 'A4', 'A4', 'G4', 'F4', 'F4', 'E4', 'E4', 'D4', 'D4', 'C4'];
            } else if (input.includes('happy birthday') || input.includes('geburtstag')) {
                sequence = ['C4', 'C4', 'D4', 'C4', 'F4', 'E4', 'C4', 'C4', 'D4', 'C4', 'G4', 'F4'];
            } else if (input.includes('mary had a little lamb') || input.includes('mary')) {
                sequence = ['E4', 'D4', 'C4', 'D4', 'E4', 'E4', 'E4', 'D4', 'D4', 'D4', 'E4', 'G4', 'G4'];
            } else if (input.includes('oh tannenbaum') || input.includes('tannenbaum')) {
                sequence = ['C4', 'F4', 'F4', 'F4', 'G4', 'A4', 'A4', 'A4', 'A4', 'G4', 'F4'];
            } else if (input.includes('alle meine entchen') || input.includes('entchen')) {
                sequence = ['C4', 'D4', 'E4', 'F4', 'G4', 'G4', 'A4', 'A4', 'A4', 'A4', 'G4'];
            } else if (input.includes('hänschen klein') || input.includes('hänschen')) {
                sequence = ['G4', 'E4', 'E4', 'F4', 'D4', 'D4', 'C4', 'D4', 'E4', 'F4', 'G4', 'G4', 'G4'];
            } else if (input.includes('backe backe kuchen') || input.includes('backe')) {
                sequence = ['C4', 'C4', 'C4', 'D4', 'E4', 'E4', 'D4', 'C4', 'D4', 'E4', 'C4'];
            } else if (input.includes('london bridge') || input.includes('london')) {
                sequence = ['G4', 'A4', 'G4', 'F4', 'E4', 'F4', 'G4', 'D4', 'E4', 'F4'];
            } else if (input.includes('frère jacques') || input.includes('bruder jakob')) {
                sequence = ['C4', 'D4', 'E4', 'C4', 'C4', 'D4', 'E4', 'C4', 'E4', 'F4', 'G4'];
            } else if (input.includes('old macdonald') || input.includes('macdonald')) {
                sequence = ['C4', 'C4', 'C4', 'G4', 'A4', 'A4', 'G4', 'E4', 'E4', 'D4', 'D4', 'C4'];
            } else if (input.includes('ode to joy') || input.includes('freude')) {
                sequence = ['E4', 'E4', 'F4', 'G4', 'G4', 'F4', 'E4', 'D4', 'C4', 'C4', 'D4', 'E4', 'E4', 'D4', 'D4'];
            } else {
                // Try to parse as note sequence
                const notePattern = /([CDEFGAB]#?[0-9]?)/gi;
                const matches = input.match(notePattern);
                
                if (matches) {
                    sequence = matches.map(note => {
                        note = note.toUpperCase();
                        if (!note.includes('4') && !note.includes('5')) {
                            note += '4'; // Default octave
                        }
                        return note;
                    }).filter(note => noteFrequencies[note]);
                }
                
                // If no specific pattern, create a simple melody from letters
                if (sequence.length === 0) {
                    const letters = input.replace(/[^a-g]/gi, '').toLowerCase();
                    const noteMap = { c: 'C4', d: 'D4', e: 'E4', f: 'F4', g: 'G4', a: 'A4', b: 'B4' };
                    sequence = Array.from(letters).map(letter => noteMap[letter]).filter(Boolean);
                }
            }
            
            if (sequence.length > 0) {
                songSequence = sequence;
                songNotes.textContent = sequence.join(' → ');
                songDisplay.classList.add('active');
            } else {
                songNotes.textContent = 'Keine gültige Notenfolge erkannt. Versuchen Sie es mit Notennamen (C D E F G A B) oder bekannten Liedern.';
                songDisplay.classList.add('active');
            }
        }

        // Play song sequence
        async function playSong() {
            if (songSequence.length === 0 || isPlaying) return;
            
            isPlaying = true;
            const tempo = parseInt(document.getElementById('tempoSlider').value);
            const noteDuration = (60 / tempo) * 1000; // Convert BPM to milliseconds
            
            for (let i = 0; i < songSequence.length; i++) {
                const note = songSequence[i];
                playNote(note);
                
                await new Promise(resolve => setTimeout(resolve, noteDuration * 0.8));
                stopNote(note);
                
                if (i < songSequence.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, noteDuration * 0.2));
                }
            }
            
            isPlaying = false;
        }

        // Recording functions
        function startRecording() {
            initAudio();
            
            isRecording = true;
            recordedNotes = [];
            recordingStartTime = Date.now();
            
            // UI updates
            const startBtn = document.getElementById('startBtn');
            const stopBtn = document.getElementById('stopBtn');
            const saveBtn = document.getElementById('saveBtn');
            const status = document.getElementById('recordingStatus');
            
            startBtn.disabled = true;
            startBtn.classList.add('recording');
            startBtn.textContent = '🔴 AUFNAHME...';
            stopBtn.disabled = false;
            saveBtn.disabled = true;
            
            status.textContent = '🔴 Aufnahme läuft - Spielen Sie Ihre Melodie!';
            status.className = 'recording-status recording';
            
            // Set up MediaRecorder for WAV export
            try {
                const dest = audioContext.createMediaStreamDestination();
                // Connect all future audio to the destination for recording
                window.recordingDestination = dest;
                
                mediaRecorder = new MediaRecorder(dest.stream);
                recordedChunks = [];
                
                mediaRecorder.ondataavailable = function(event) {
                    if (event.data.size > 0) {
                        recordedChunks.push(event.data);
                    }
                };
                
                mediaRecorder.start();
            } catch (error) {
                console.log('MediaRecorder not supported, using note-based recording');
            }
        }

        function stopRecording() {
            isRecording = false;
            
            // UI updates
            const startBtn = document.getElementById('startBtn');
            const stopBtn = document.getElementById('stopBtn');
            const saveBtn = document.getElementById('saveBtn');
            const status = document.getElementById('recordingStatus');
            
            startBtn.disabled = false;
            startBtn.classList.remove('recording');
            startBtn.textContent = '🔴 START';
            stopBtn.disabled = true;
            saveBtn.disabled = false;
            
            status.textContent = `✅ Aufnahme beendet - ${recordedNotes.length / 2} Noten aufgenommen`;
            status.className = 'recording-status ready';
            
            // Stop MediaRecorder
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
            }
        }

        function saveRecording() {
            if (recordedNotes.length === 0) {
                alert('Keine Aufnahme zum Speichern vorhanden!');
                return;
            }
            
            // Create a simple WAV-like data structure with the recorded notes
            const sampleRate = 44100;
            const duration = Math.max(...recordedNotes.map(n => n.time)) / 1000 + 1;
            const numSamples = Math.floor(sampleRate * duration);
            const audioBuffer = new Float32Array(numSamples);
            
            // Render the recorded notes into the audio buffer
            let activeNotes = {};
            let currentSampleTime = 0;
            
            for (let i = 0; i < numSamples; i++) {
                const timeInMs = (i / sampleRate) * 1000;
                
                // Check for note events at this time
                recordedNotes.forEach(event => {
                    if (Math.abs(event.time - timeInMs) < 10) { // 10ms tolerance
                        if (event.type === 'start') {
                            activeNotes[event.note] = noteFrequencies[event.note];
                        } else if (event.type === 'stop') {
                            delete activeNotes[event.note];
                        }
                    }
                });
                
                // Generate audio sample
                let sample = 0;
                const volume = document.getElementById('volumeSlider').value / 100;
                
                Object.values(activeNotes).forEach(frequency => {
                    sample += Math.sin(2 * Math.PI * frequency * (i / sampleRate)) * volume * 0.3;
                });
                
                // Normalize if multiple notes
                const numActiveNotes = Object.keys(activeNotes).length;
                if (numActiveNotes > 1) {
                    sample /= numActiveNotes;
                }
                
                audioBuffer[i] = Math.max(-1, Math.min(1, sample));
            }
            
            // Convert to 16-bit PCM
            const pcmBuffer = new Int16Array(numSamples);
            for (let i = 0; i < numSamples; i++) {
                pcmBuffer[i] = Math.max(-32767, Math.min(32767, audioBuffer[i] * 32767));
            }
            
            // Create WAV file
            const wavBuffer = createWAVFile(pcmBuffer, sampleRate);
            const blob = new Blob([wavBuffer], { type: 'audio/wav' });
            
            // Download the file
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `klavieraufnahme-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.wav`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('Aufnahme als WAV-Datei gespeichert!');
        }

        // Create WAV file buffer
        function createWAVFile(samples, sampleRate) {
            const buffer = new ArrayBuffer(44 + samples.length * 2);
            const view = new DataView(buffer);
            
            // WAV header
            const writeString = (offset, string) => {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            };
            
            writeString(0, 'RIFF');
            view.setUint32(4, 36 + samples.length * 2, true);
            writeString(8, 'WAVE');
            writeString(12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, 1, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 2, true);
            view.setUint16(32, 2, true);
            view.setUint16(34, 16, true);
            writeString(36, 'data');
            view.setUint32(40, samples.length * 2, true);
            
            // Write samples
            let offset = 44;
            for (let i = 0; i < samples.length; i++) {
                view.setInt16(offset, samples[i], true);
                offset += 2;
            }
            
            return buffer;
        }

        // Initialize the piano when the page loads
        document.addEventListener('DOMContentLoaded', function() {
            generatePiano();
            
            // Initialize audio on first user interaction
            document.addEventListener('click', initAudio, { once: true });
            document.addEventListener('keydown', initAudio, { once: true });
        });

        // Volume control
        document.getElementById('volumeSlider').addEventListener('input', function() {
            // Volume will be applied to new notes automatically
        });

        // Prevent context menu on piano keys
        document.addEventListener('contextmenu', function(e) {
            if (e.target.classList.contains('key')) {
                e.preventDefault();
            }
        });
    </script>
</body>
</html>
